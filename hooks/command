#!/bin/bash

set -euo pipefail

DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# shellcheck source=lib/shared.bash
. "$DIR/../lib/shared.bash"

# shellcheck source=lib/plugin.bash
. "$DIR/../lib/plugin.bash"

# Global variable used by plugin_read_list_into_result
result=()

# Optional: Load feature modules for complex plugins
# shellcheck source=lib/modules/example.bash
# . "$DIR/../lib/modules/example.bash"

# Usage: validate_timeout (ensures timeout is within acceptable range)
validate_timeout() {
  local timeout_option
  timeout_option=$(plugin_read_config TIMEOUT "")
  if [ -n "${timeout_option}" ]; then
    if [[ "$timeout_option" -lt 1 || "$timeout_option" -gt 60 ]]; then
      log_error "timeout must be between 1 and 60 seconds"
      exit 1
    fi
  fi
}

main() {
  # Set up error reporting and debug mode
  setup_error_trap
  enable_debug_if_requested

  # Get configuration
  local optional_option
  optional_option=$(plugin_read_config OPTIONAL "default")

  # Validate configuration
  validate_timeout

  echo "--- :hammer: Running plugin"

  log_info "Running plugin with options:"
  log_info "optional: ${optional_option}"

  log_info "Checking BUILDKITE_HOOKS_PATH: ${BUILDKITE_HOOKS_PATH:-not set}"
  log_info "Verifying pre command hooks ran:"
  if [ "${PLUGIN_ENVIRONMENT_SET:-false}" = "true" ]; then
    log_info "Environment hook was run"
  else
    log_warning "Environment hook was not run"
  fi
  
  if [ "${PLUGIN_PRE_CHECKOUT_RAN:-false}" = "true" ]; then
    log_info "Pre-checkout tasks were run"
  else
    log_warning "Pre-checkout tasks were not run"
  fi

  if [ "${PLUGIN_POST_CHECKOUT_RAN:-false}" = "true" ]; then
    log_info "Post-checkout tasks were run"
  else
    log_warning "Post-checkout tasks were not run"
  fi

  # check if you can access the plugin log file set in environment hook
  local log_file="${PLUGIN_LOGFILE:-plugin_default_log.txt}"
  log_info "Accessing plugin log file at:  $(pwd)/${log_file}" 
  if [ -f "$log_file" ]; then
    log_info "Plugin log file exists. Log file content:"
    cat "$log_file"  
  else
    log_warning "Plugin log file does not exist."
  fi
  export PLUGIN_COMMAND_RAN="true"

  # Your main plugin logic here
  log_success "Plugin executed successfully"
}

main "$@"
